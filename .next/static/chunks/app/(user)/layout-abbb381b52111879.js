(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[743],{10562:function(e,t,s){Promise.resolve().then(s.bind(s,33038))},33038:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return ee}});var n=s(57437),a=s(2265),r=s(35843),i=s(89975),l=s(76500),o=s(39227),c=s(34989),d=s(52653),u=s(43226),h=s(54873),x=s(39400),m=s(12339),v=s(33932),p=s(82477),g=s(30402),j=s(90006),f=s(4856),Z=s(63955),y=s(61396),w=s.n(y),b=s(3283),k=s(54986),_=s(8864),C=s(21975),S=s(59104),N=s(26409),D=s(82749),M=s(24033),z=s(46986),I=s(94758),E=s(29951),A=s(35551),P=s(38130),T=s(81835),U=s(33533),B=s(26398);s(17446);var O=s(41507),G=s(93046);s(76890);var R=s(98707),F=function(e){var t,s;let{message:a}=e,{currentUserData:r}=(0,G.v9)(e=>e.user),{selectedChat:i}=(0,G.v9)(e=>e.chat),l=a.sender._id===(null==r?void 0:r._id),o=!1;return(i&&(null==i?void 0:null===(t=i.users)||void 0===t?void 0:t.length)-1===(null===(s=a.readBy)||void 0===s?void 0:s.length)&&(o=!0),l)?(0,n.jsxs)("div",{className:"message-row left",children:[(0,n.jsx)("img",{src:"".concat("http://160.25.81.159:8000","/image/user/").concat(a.sender.avatar),alt:"avatar",className:"avatar"}),(0,n.jsxs)("div",{className:"message-content",children:[(0,n.jsxs)("div",{className:"text-message receiver",children:[(0,n.jsx)("span",{className:"sender-name",children:a.sender.name}),a.text&&(0,n.jsx)("p",{className:"text",children:a.text})]}),a.image&&(0,n.jsx)("img",{src:a.image,alt:"message",className:"message-image receiver"}),(0,n.jsx)("span",{className:"timestamp",children:(0,R.o)(a.createdAt)})]})]}):(0,n.jsxs)("div",{className:"message-row right",children:[(0,n.jsxs)("div",{className:"message-content",children:[a.text&&(0,n.jsx)("p",{className:"text-message sender",children:a.text}),a.image&&(0,n.jsx)("img",{src:a.image,alt:"message",className:"message-image sender"}),(0,n.jsxs)("div",{className:"message-footer",children:[(0,n.jsx)("span",{className:"timestamp",children:(0,R.o)(a.createdAt)}),(0,n.jsx)("i",{className:"ri-check-double-line ".concat(o?"read":"unread")})]})]}),(0,n.jsx)("img",{src:"".concat("http://160.25.81.159:8000","/image/user/").concat(a.sender.avatar),alt:"avatar",className:"avatar"})]})},Y=s(74548),K=s.n(Y),L=e=>{let{onClose:t}=e,{data:s}=(0,D.useSession)(),[r,i]=a.useState(""),[l,o]=a.useState([]),[c,u]=a.useState(!1),{selectedChat:h,chats:x}=(0,G.v9)(e=>e.chat),{currentUserData:m}=(0,G.v9)(e=>e.user),v=(0,a.useRef)(null);(0,G.I0)();let p=async()=>{try{var e;u(!0),console.log(">> check chat",h);let t=await (0,T.w)({url:"".concat("http://160.25.81.159:8000/api/v1","/messages/chat?chatID=").concat(null==h?void 0:h._id),method:"GET",headers:{Authorization:"Bearer ".concat(null==s?void 0:null===(e=s.user)||void 0===e?void 0:e.access_token)}});(null==t?void 0:t.data)&&o(t.data)}catch(e){console.log(e)}finally{u(!1)}};a.useEffect(()=>{p()},[m]);let g=async()=>{try{var e;if(!r)return;if(u(!0),O.Z.connect()||O.Z.connect(),null==s?void 0:s.user){let t={text:r,image:"",socketMessageId:K()().unix(),chat:null==h?void 0:h._id,sender:null==s?void 0:s.user._id};O.Z.emit("send-new-message",t),i(""),await (0,T.w)({url:"".concat("http://160.25.81.159:8000/api/v1","/messages"),method:"POST",headers:{Authorization:"Bearer ".concat(null==s?void 0:null===(e=s.user)||void 0===e?void 0:e.access_token)},body:t});let n={text:r,image:"",socketMessageId:K()().unix(),chat:null==h?void 0:h._id,sender:{_id:s.user._id,name:s.user.name,email:s.user.email,avatar:s.user.avatar}};o(e=>[...e,n])}}catch(e){console.log(e)}finally{u(!1)}};return(0,a.useEffect)(()=>{O.Z.connect()||O.Z.connect(),O.Z.on("new-message-received",e=>{(null==h?void 0:h._id)===e.chat._id&&o(t=>{let s=t.find(t=>t.socketMessageId===e.socketMessageId);return s?t:[...t,e]})}),O.Z.on("user-read-all-chat-messages",e=>{let{chatId:t,readByUserId:s}=e;(null==h?void 0:h._id)===t&&o(e=>{let t=e.map(e=>e.sender._id===s||e.readBy.includes(s)?e:{...e,readBy:[...e.readBy,s]});return t})})},[h]),(0,a.useEffect)(()=>{v.current&&(v.current.scrollTop=v.current.scrollHeight+100)},[l]),(0,a.useEffect)(()=>{O.Z.connect()||O.Z.connect(),O.Z.emit("typing",{chat:h,senderId:null==m?void 0:m._id,senderName:null==m?void 0:m.name.split(" ")[0]})},[h,r]),(0,n.jsxs)("div",{className:"chat-box",children:[(0,n.jsxs)("div",{className:"chat-header",children:[(0,n.jsxs)("div",{className:"chat-user",children:[(0,n.jsx)(b.Z,{alt:null==m?void 0:m.avatar,src:"".concat("http://160.25.81.159:8000","/image/user/").concat(null==m?void 0:m.avatar)}),(0,n.jsx)("span",{children:null==m?void 0:m.name})]}),(0,n.jsx)(d.Z,{size:"small",onClick:t,children:(0,n.jsx)(U.Z,{style:{color:"white"}})})]}),(0,n.jsx)("div",{className:"chat-messages",ref:v,children:l&&l.map(e=>(0,n.jsx)(F,{message:e}))}),(0,n.jsxs)("div",{className:"chat-input",children:[(0,n.jsx)(C.Z,{fullWidth:!0,size:"small",placeholder:"Aa",variant:"outlined",value:r,onChange:e=>i(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),g())}}),(0,n.jsx)(d.Z,{color:"primary",onClick:()=>g(),children:(0,n.jsx)(B.Z,{})})]})]})},W=s(35266),$=s(80356),q=s(73393),H=s(71971),J=s(102),Q=e=>{let{users:t,setSelectedUser:s,setAnchorEl:a,search:r,chats:i}=e,{data:l}=(0,D.useSession)(),{onlineUsers:o}=(0,G.v9)(e=>e.user),c=(0,G.I0)(),d=async(e,t)=>{var n,r;let i=await (0,T.w)({url:"".concat("http://160.25.81.159:8000/api/v1","/chats"),method:"POST",headers:{Authorization:"Bearer ".concat(null==l?void 0:null===(n=l.user)||void 0===n?void 0:n.access_token)},body:{users:[null==l?void 0:l.user._id,e._id],isGroupChat:!1}});s(e),c((0,H.pw)(e)),(null==i?void 0:i.data)===!0?c((0,J.$g)(t)):c((0,J.$g)(i.data)),a(null),O.Z.connect()||O.Z.connect(),O.Z.emit("read-all-messages",{chatId:null==t?void 0:t._id,readByUserId:null==l?void 0:null===(r=l.user)||void 0===r?void 0:r._id,users:null==t?void 0:t.users.filter(e=>{var t;return e._id!==(null==l?void 0:null===(t=l.user)||void 0===t?void 0:t._id)}).map(e=>e._id)})};return(0,n.jsx)(W.Z,{dense:!0,children:t.map((e,t)=>{var s,a,r;return(0,n.jsxs)($.ZP,{button:!0,onClick:()=>d(e,i[t]),style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,n.jsxs)("div",{style:{display:"flex",alignItems:"center"},children:[(0,n.jsx)(q.Z,{children:(0,n.jsx)(b.Z,{alt:e.name,src:"".concat("http://160.25.81.159:8000","/image/user/").concat(e.avatar)})}),(0,n.jsxs)("div",{children:[(0,n.jsx)("p",{style:{margin:0},children:e.name}),(null===(a=i[t])||void 0===a?void 0:null===(s=a.lastMessage)||void 0===s?void 0:s.sender)&&(0,n.jsx)("p",{style:{margin:0,fontSize:10},children:(i[t].lastMessage.sender._id===(null==l?void 0:null===(r=l.user)||void 0===r?void 0:r._id)?"Bạn":i[t].lastMessage.sender.name)+": "+i[t].lastMessage.text})]})]}),(null==l?void 0:l.user)&&o.includes(e._id)&&(0,n.jsx)("div",{style:{background:"green",height:10,width:10,borderRadius:"50%"}})]},e._id)})})};function V(){let{data:e}=(0,D.useSession)(),[t,s]=a.useState(null),[r,i]=a.useState(""),l=!!t,[o,c]=a.useState([]),[u,h]=a.useState([]),[m,p]=a.useState(null),g=async()=>{let e=await (0,T.w)({url:"".concat("http://160.25.81.159:8000/api/v1","/users/all"),method:"GET"});(null==e?void 0:e.data)&&c(e.data)},j=async()=>{var t;let s=await (0,T.w)({url:"".concat("http://160.25.81.159:8000/api/v1","/chats"),method:"GET",headers:{Authorization:"Bearer ".concat(null==e?void 0:null===(t=e.user)||void 0===t?void 0:t.access_token)}});if(null==s?void 0:s.data){h(s.data);let t=s.data.flatMap(e=>e.users),n=Array.from(new Map(t.filter(t=>{var s;return t._id!==(null==e?void 0:null===(s=e.user)||void 0===s?void 0:s._id)}).map(e=>[e._id,e])).values());c(n)}};return a.useEffect(()=>{j()},[]),(0,n.jsxs)("div",{children:[(0,n.jsx)(A.Z,{id:"chat-button","aria-controls":l?"chat-menu":void 0,"aria-haspopup":"true","aria-expanded":l?"true":void 0,onClick:e=>{s(e.currentTarget)},children:(0,n.jsx)(d.Z,{children:(0,n.jsx)(x.Z,{badgeContent:0,color:"error",children:(0,n.jsx)(P.Z,{})})})}),(0,n.jsxs)(v.Z,{id:"chat-menu",anchorEl:t,open:l,onClose:()=>s(null),sx:{width:450},children:[(0,n.jsx)("div",{style:{padding:"8px 16px",width:450},children:(0,n.jsx)(C.Z,{fullWidth:!0,size:"small",placeholder:"T\xecm kiếm người d\xf9ng",value:r,onChange:e=>{i(e.target.value)},onClick:()=>g()})}),(0,n.jsx)(k.Z,{}),(0,n.jsx)(Q,{users:o,setSelectedUser:p,setAnchorEl:s,search:r,chats:u})]}),m&&(0,n.jsx)(L,{onClose:()=>p(null)})]})}function X(){var e,t,s,r;let{data:i}=(0,D.useSession)(),[h,y]=a.useState(""),A=(0,M.useRouter)(),[P,T]=a.useState(null),[U,B]=a.useState(null),G=e=>{T(e.currentTarget)},R=()=>{B(null)},F=()=>{(null==i?void 0:i.user)&&(O.Z.connect()||O.Z.connect(),O.Z.emit("logout",{userID:i.user._id,socketId:O.Z.id}))},Y=(0,n.jsxs)(v.Z,{anchorEl:P,id:"primary-search-account-menu",keepMounted:!0,open:!!P,onClose:()=>{T(null),R()},transformOrigin:{horizontal:"right",vertical:"top"},anchorOrigin:{horizontal:"right",vertical:"bottom"},slotProps:{paper:{elevation:0,sx:{overflow:"visible",filter:"drop-shadow(0px 2px 8px rgba(0,0,0,0.32))",mt:1.5,"& .MuiAvatar-root":{width:32,height:32,ml:-.5,mr:1},"&::before":{content:'""',display:"block",position:"absolute",top:0,right:14,width:10,height:10,bgcolor:"background.paper",transform:"translateY(-50%) rotate(45deg)",zIndex:0}}}},children:[(0,n.jsxs)(m.Z,{sx:{a:{textDecoration:"unset",color:"unset"}},children:[(0,n.jsx)(b.Z,{}),(0,n.jsx)(w(),{href:"/profile/".concat(null==i?void 0:null===(e=i.user)||void 0===e?void 0:e._id),children:"Trang c\xe1 nh\xe2n"})]}),(0,n.jsx)(k.Z,{}),(0,n.jsxs)(m.Z,{sx:{a:{textDecoration:"unset",color:"unset"}},children:[(0,n.jsx)(I.Z,{sx:{mr:1}}),(0,n.jsx)(w(),{href:"/utils/".concat(2),children:"Danh s\xe1ch ph\xe1t"})]}),(0,n.jsxs)(m.Z,{sx:{a:{textDecoration:"unset",color:"unset"}},children:[(0,n.jsx)(z.default,{fontSize:"small",sx:{mr:1}}),(0,n.jsx)(w(),{href:"/utils/".concat(1),children:"Danh s\xe1ch y\xeau th\xedch"})]}),(0,n.jsxs)(m.Z,{sx:{a:{textDecoration:"unset",color:"unset"}},children:[(0,n.jsx)(E.Z,{fontSize:"small",sx:{mr:1}}),(0,n.jsx)(w(),{href:"/utils/".concat(0),children:"Lịch sử"})]}),(0,n.jsxs)(m.Z,{sx:{a:{textDecoration:"unset",color:"unset"}},children:[(0,n.jsx)(_.Z,{children:(0,n.jsx)(N.Z,{fontSize:"small"})}),(0,n.jsx)(w(),{href:"/utils/".concat(4),children:"Group"})]}),(0,n.jsxs)(m.Z,{onClick:()=>{(0,D.signOut)(),F()},children:[(0,n.jsx)(_.Z,{children:(0,n.jsx)(S.Z,{fontSize:"small"})}),"Đăng xuất"]})]}),K="primary-search-account-menu-mobile",L=(0,n.jsxs)(v.Z,{anchorEl:U,anchorOrigin:{vertical:"top",horizontal:"right"},id:K,keepMounted:!0,transformOrigin:{vertical:"top",horizontal:"right"},open:!!U,onClose:R,children:[(0,n.jsxs)(m.Z,{children:[(0,n.jsx)(d.Z,{size:"large","aria-label":"show 4 new mails",color:"inherit",children:(0,n.jsx)(x.Z,{badgeContent:4,color:"error",children:(0,n.jsx)(g.Z,{})})}),(0,n.jsx)("p",{children:"Messages"})]}),(0,n.jsxs)(m.Z,{children:[(0,n.jsx)(d.Z,{size:"large","aria-label":"show 17 new notifications",color:"inherit",children:(0,n.jsx)(x.Z,{badgeContent:17,color:"error",children:(0,n.jsx)(j.Z,{})})}),(0,n.jsx)("p",{children:"Notifications"})]}),(0,n.jsxs)(m.Z,{onClick:G,children:[(0,n.jsx)(d.Z,{size:"large","aria-label":"account of current user","aria-controls":"primary-search-account-menu","aria-haspopup":"true",color:"inherit",children:(0,n.jsx)(p.Z,{})}),(0,n.jsx)("p",{children:"Profile"})]})]});return(0,n.jsxs)(o.Z,{sx:{flexGrow:1},children:[(0,n.jsx)(Z.Z,{children:(0,n.jsx)(l.Z,{position:"static",sx:{background:"white",color:"black",border:"2px dashed",borderRadius:"5px"},children:(0,n.jsxs)(c.Z,{children:[(0,n.jsx)(u.Z,{variant:"h6",noWrap:!0,component:"div",sx:{display:{xs:"none",sm:"block","> a":{color:"unset",textDecoration:"unset"}}},children:(0,n.jsx)(w(),{href:"/",children:"SoundCloud"})}),(0,n.jsx)(C.Z,{fullWidth:!0,label:"T\xecm kiếm...",value:h,variant:"standard",sx:{width:"40%",ml:4,mb:3},onChange:e=>y(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),A.push("/search/".concat(h)))}}),(0,n.jsx)(o.Z,{sx:{flexGrow:1}}),(0,n.jsx)(o.Z,{sx:{display:{xs:"none",md:"flex"},alignItems:"center",gap:"15px","> a":{color:"unset",textDecoration:"unset"},cursor:"pointer"},children:i?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(w(),{href:"/track/upload",children:"Upload"}),(0,n.jsx)(V,{}),(0,n.jsx)(w(),{href:"/profile/".concat(null==i?void 0:null===(t=i.user)||void 0===t?void 0:t._id),children:null==i?void 0:null===(s=i.user)||void 0===s?void 0:s.name}),(0,n.jsx)(b.Z,{sx:{width:32,height:32},onClick:G,src:"".concat("http://160.25.81.159:8000","/image/user/").concat(null==i?void 0:null===(r=i.user)||void 0===r?void 0:r.avatar)})]}):(0,n.jsx)(n.Fragment,{children:(0,n.jsx)(w(),{href:"/auth/signin",children:"Đăng nhập"})})}),(0,n.jsx)(o.Z,{sx:{display:{xs:"flex",md:"none"}},children:(0,n.jsx)(d.Z,{size:"large","aria-label":"show more","aria-controls":K,"aria-haspopup":"true",onClick:e=>{B(e.currentTarget)},color:"inherit",children:(0,n.jsx)(f.Z,{})})})]})})}),L,Y]})}function ee(e){let{children:t}=e;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(X,{}),t]})}(0,r.ZP)("div")(e=>{let{theme:t}=e;return{position:"relative",borderRadius:t.shape.borderRadius,backgroundColor:(0,i.Fq)(t.palette.common.white,.15),"&:hover":{backgroundColor:(0,i.Fq)(t.palette.common.white,.25)},marginRight:t.spacing(2),marginLeft:0,width:"100%",[t.breakpoints.up("sm")]:{marginLeft:t.spacing(3),width:"auto"}}}),(0,r.ZP)("div")(e=>{let{theme:t}=e;return{padding:t.spacing(0,2),height:"100%",position:"absolute",pointerEvents:"none",display:"flex",alignItems:"center",justifyContent:"center"}}),(0,r.ZP)(h.ZP)(e=>{let{theme:t}=e;return{color:"inherit","& .MuiInputBase-input":{padding:t.spacing(1,1,1,0),paddingLeft:"calc(1em + ".concat(t.spacing(4),")"),transition:t.transitions.create("width"),width:"100%",[t.breakpoints.up("md")]:{width:"300px"}}}})},98707:function(e,t,s){"use strict";s.d(t,{o:function(){return l}});var n=s(74548),a=s.n(n),r=s(6537),i=s.n(r);s(93358),a().extend(i()),a().locale("vi");let l=e=>{let t=a()(),s=a()(e);return 1>t.diff(s,"minute")?"now":1>t.diff(s,"hour")||1>t.diff(s,"day")?s.format("hh:mm A"):1>t.diff(s,"year")?s.format("MMM DD hh:mm A"):s.format("DDD MM YYYY hh:mm A")};t.Z=a()},102:function(e,t,s){"use strict";s.d(t,{$g:function(){return i}});var n=s(39730);let a=(0,n.oM)({name:"chat",initialState:{chats:[],selectedChat:null},reducers:{SetChats:(e,t)=>{e.chats=t.payload},SetSelectedChat:(e,t)=>{e.selectedChat=t.payload}}}),{SetChats:r,SetSelectedChat:i}=a.actions;t.ZP=a},71971:function(e,t,s){"use strict";s.d(t,{cx:function(){return l},pw:function(){return r}});var n=s(39730);let a=(0,n.oM)({name:"user",initialState:{currentUserData:null,currentUserId:"",onlineUsers:[]},reducers:{SetCurrentUser:(e,t)=>{e.currentUserData=t.payload},SetCurrentUserId:(e,t)=>{e.currentUserId=t.payload},SetOnlineUsers:(e,t)=>{e.onlineUsers=t.payload}}}),{SetCurrentUser:r,SetCurrentUserId:i,SetOnlineUsers:l}=a.actions;t.ZP=a},41507:function(e,t,s){"use strict";let{io:n}=s(60348),a=n("http://localhost:8000",{autoConnect:!1,withCredentials:!0});t.Z=a},81835:function(e,t,s){"use strict";s.d(t,{w:function(){return n}});let n=async e=>{let{url:t,method:s,body:n,useCredentials:a=!1,headers:r={},nextOption:i={}}=e,l={method:s,headers:new Headers({"content-type":"application/json",...r}),body:n?JSON.stringify(n):null,...i};return a&&(l.credentials="include"),fetch(t,l).then(e=>e.ok?e.json():e.json().then(function(t){var s,n;return{statusCode:e.status,message:null!==(s=null==t?void 0:t.message)&&void 0!==s?s:"",error:null!==(n=null==t?void 0:t.error)&&void 0!==n?n:""}}))}},17446:function(){},76890:function(){}},function(e){e.O(0,[0,256,709,690,61,305,975,870,262,901,988,971,596,744],function(){return e(e.s=10562)}),_N_E=e.O()}]);